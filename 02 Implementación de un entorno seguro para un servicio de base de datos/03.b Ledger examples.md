# Ejemplos de uso de Ledger en Azure SQL Database

Estos ejemplos muestran comandos y consultas de interés para trabajar con el libro de contabilidad (ledger) en Azure SQL Database. Están comentados y ordenados para ejecución en un entorno de prueba.

**Orden de ejecución recomendado:**
1. Crear las tablas ledger-enabled.
2. Insertar/actualizar datos de ejemplo.
3. Consultar la tabla principal para ver las columnas ledger.
4. Consultar la tabla de historial ledger (MSSQL_LedgerHistoryFor_<object_id>).
5. Comprobar metadatos en `sys.tables`.

---

## 1) Crear tablas ledger-enabled
Descripción: crea dos tablas de ejemplo; la primera con ledger y system-versioning, la segunda con modo append-only.

```sql
-- 1a. Tabla con LEDGER activado y SYSTEM_VERSIONING (modo temporal + ledger)
CREATE TABLE Demos (
		Id INT PRIMARY KEY,
		Cliente NVARCHAR(100),
		Importe DECIMAL(10,2)
) WITH (LEDGER = ON, SYSTEM_VERSIONING = ON);

-- 1b. Tabla con LEDGER en modo append-only (no versionado temporal completo)
CREATE TABLE Demos2 (
		Id INT PRIMARY KEY,
		Cliente NVARCHAR(100),
		Importe DECIMAL(10,2)
) WITH (LEDGER = ON (APPEND_ONLY = ON));

-- Comentario: ajuste nombres y tipos según su modelo. Crear tablas ledger puede implicar requisitos
-- de rol y permisos, y conlleva incremento de almacenamiento por el historial.
```

## 2) Insertar datos de ejemplo

```sql
-- Inserciones de prueba
INSERT INTO Demos (Id, Cliente, Importe) VALUES (1, N'ACME S.A.', 100.00);
INSERT INTO Demos (Id, Cliente, Importe) VALUES (2, N'Beta S.L.', 250.50);

-- Actualizar y eliminar para generar entradas en el ledger
UPDATE Demos SET Importe = 120.00 WHERE Id = 1;
DELETE FROM Demos WHERE Id = 2;

-- Comentario: cada cambio queda reflejado en las estructuras internas del ledger.
```

## 3) Consultar la tabla principal (ver columnas ledger)
Descripción: las tablas ledger exponen columnas del sistema que indican rangos/transacciones de ledger.

```sql
-- 3. Consultar filas y columnas relacionadas con ledger
SELECT TOP (1000)
			[Id]
		, [Cliente]
		, [Importe]
		, [ledger_start_transaction_id]
		, [ledger_end_transaction_id]
		, [ledger_start_sequence_number]
		, [ledger_end_sequence_number]
FROM [dbo].[Demos];

-- Comentario: las columnas ledger_* son añadidas por el motor para rastrear integridad.
```

## 4) Consultar la tabla de historial ledger
Descripción: Azure SQL crea una tabla de historial con nombre del patrón `MSSQL_LedgerHistoryFor_<object_id>`.

```sql
-- 4. Consultar la tabla de historial (objeto generado por el sistema)
SELECT TOP (1000)
			[Id]
		, [Cliente]
		, [Importe]
		, [ledger_start_transaction_id]
		, [ledger_end_transaction_id]
		, [ledger_start_sequence_number]
		, [ledger_end_sequence_number]
FROM [dbo].[MSSQL_LedgerHistoryFor_1458104235];

-- Comentario: reemplace el sufijo con el object_id real de su tabla. Para hallar el nombre exacto,
-- consulte el catálogo (ver sección siguiente).
```

## 5) Consultar metadatos del ledger en `sys.tables`

```sql
-- 5. Ver tipo de ledger y view id desde el catálogo
SELECT name, ledger_type, ledger_type_desc, ledger_view_id
FROM sys.tables;

-- Comentario: `ledger_type` indica si la tabla tiene ledger y su modo; `ledger_view_id` permite
-- relacionar con vistas/objetos auxiliares creados por el motor.
```

## Consultas y comandos adicionales de interés

- Buscar las tablas de historial generadas por el sistema:

```sql
SELECT name, object_id
FROM sys.objects
WHERE name LIKE 'MSSQL_LedgerHistoryFor_%';
```

- Obtener el object_id de la tabla para localizar su historial:

```sql
SELECT OBJECT_ID('dbo.Demos') AS object_id;
-- Con el object_id, puede construir el nombre del historial o consultar sys.objects.
```

- Notas sobre pruebas de integridad y pruebas externas:
	- Azure SQL Ledger permite generar evidencias (proofs) y anchors que se pueden verificar externamente.
	- Los comandos específicos para generar y verificar proofs cambian con el tiempo; consulte la documentación
		oficial para la versión exacta de su servidor. Generalmente los pasos son: generar la prueba desde la BD,
		exportar el anchor y verificarlo con la utilidad/servicio de verificación.

## Buenas prácticas y advertencias

- Planifique capacidad de almacenamiento y costes: el ledger incrementa el historial y tamaño de datos.
- Use ledger para escenarios que requieren integridad verificable: contabilidad, registros financieros, contratos.
- No intente modificar las tablas `MSSQL_LedgerHistoryFor_*` directamente; son gestionadas por el motor.
- Automatice la exportación de anchors y pruebas de verificación para auditoría regular.

## Referencias

- Documento general de Azure SQL (busque "ledger"): https://learn.microsoft.com/azure/azure-sql/
- Ejemplos y guía de ledger en Azure SQL (ver documentación actualizada en MS Learn).
