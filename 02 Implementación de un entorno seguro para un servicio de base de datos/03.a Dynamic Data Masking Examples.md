# Ejemplos de Dynamic Data Masking (DDM) — AdventureWorksLT

Estos ejemplos están pensados para ejecutarse sobre la base de datos `AdventureWorksLT` y muestran el orden recomendado de ejecución junto con comentarios explicativos.

**Orden de ejecución (resumen):**
1. Comprobar los datos actuales.
2. Aplicar la máscara a la columna.
3. Crear un usuario de ejemplo.
4. Ajustar permisos (`REVOKE`/`GRANT`) para ilustrar `UNMASK`.
5. Probar las consultas bajo el usuario enmascarado.

---

## 1) Comprobar los datos actuales
Descripción: ver el contenido actual de la tabla antes de aplicar cualquier máscara.

```sql
-- 1. Ver todos los registros (ejecútese como administrador o usuario con SELECT)
SELECT * FROM SalesLT.Customer;
```

## 2) Aplicar Dynamic Data Masking
Descripción: añade una máscara de tipo `email()` a la columna `EmailAddress`. No modifica el dato en la tabla, solo cómo se muestra a los usuarios que no tienen el permiso `UNMASK`.

```sql
-- 2. Aplicar máscara a la columna EmailAddress
ALTER TABLE SalesLT.Customer
ALTER COLUMN EmailAddress ADD MASKED WITH (FUNCTION = 'email()');
GO

-- Nota: Después de esto, las consultas que ejecuten usuarios sin permiso UNMASK verán la dirección enmascarada.
```

## 3) Crear un usuario de ejemplo
Descripción: crear un usuario de base de datos para simular un rol con permisos limitados.

```sql
-- 3. Crear un usuario de ejemplo (solo para demostración)
-- Atención: no use contraseñas en claro en producción; esto es solo ejemplo.
CREATE USER SalesUser WITH PASSWORD = 'azurePa$$w0rd';
GO
```

## 4) Gestionar permisos de UNMASK
Descripción: `UNMASK` permite ver los datos sin enmascarar. Aquí se muestra primero un `REVOKE` (ejemplo de retirar permiso) y luego un `GRANT` con `SELECT` y `UNMASK`.

```sql
-- 4a. Revocar permiso UNMASK en la tabla (si existiera)
REVOKE UNMASK
	ON SalesLT.Customer TO SalesUser;
GO

-- 4b. Conceder permisos SELECT y UNMASK para que el usuario pueda ver datos sin máscara
GRANT SELECT, UNMASK
	ON SalesLT.Customer TO SalesUser;
GO

-- Comentario: en muchos escenarios se concede SELECT pero NO UNMASK; conceder UNMASK debe hacerse
-- solo a roles/usuarios de confianza (p. ej. soporte o procesos autorizados).
```

## 5) Probar la consulta como el usuario restringido
Descripción: usar `EXECUTE AS` para simular la ejecución bajo `SalesUser` y observar la diferencia con/sin `UNMASK`.

```sql
-- 5. Ejecutar como SalesUser para ver cómo se muestran los datos
EXECUTE AS USER = 'SalesUser';
SELECT * FROM SalesLT.Customer; -- mostrará EmailAddress enmascarado si el usuario no tiene UNMASK
REVERT;
GO

-- Si el usuario tiene el permiso UNMASK, verá el valor real en lugar de la máscara.
```

---

**Notas importantes y buenas prácticas**
- Estos ejemplos usan `AdventureWorksLT` y la tabla `SalesLT.Customer` como entorno de pruebas.
- No use contraseñas en claro en scripts para producción; gestione credenciales con Azure Key Vault o sistemas de secret management.
- `DDM` no es un mecanismo criptográfico: combine con cifrado en reposo (TDE/Always Encrypted si aplica), RLS y auditoría.
- Revise y documente quién tiene `UNMASK` en su organización; limite su uso y audítelo.
